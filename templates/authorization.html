{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Вход через VK ID</h1>
    <div id="vkid-widget"></div> <!-- Контейнер для виджета VK ID -->
</div>

<!-- Скрипты -->
<script async src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
<script type="text/javascript">
    if ('VKIDSDK' in window) {
        console.log("VKID SDK загружен.");
        const VKID = window.VKIDSDK;

        VKID.Config.init({
            app: 53018977,
            redirectUrl: 'https://gymnazium587-itemapotema.amvera.io/auth_vk',
            responseMode: VKID.ConfigResponseMode.Callback,
            source: VKID.ConfigSource.LOWCODE,
            scope: '', // Укажите нужные разрешения
        });

        const oneTap = new VKID.OneTap();

        oneTap.render({
            container: document.getElementById("vkid-widget"),
            showAlternativeLogin: true
        })
        .on(VKID.WidgetEvents.ERROR, vkidOnError)
        .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
            const code = payload.code;
            const deviceId = payload.device_id;

            VKID.Auth.exchangeCode(code, deviceId)
                .then(vkidOnSuccess)
                .catch(vkidOnError);
        });

        function vkidOnSuccess(data) {
            const tg = window.Telegram.WebApp;
            if (!tg.initDataUnsafe?.user) {
                console.error("Пользователь Telegram не авторизован.");
                return;
            }
            const initData = Telegram.WebApp.initData;

            const user_data = {
                tg_id: tg.initDataUnsafe.user.id,
                vk_id: data.user_id,
                tg_name: tg.initDataUnsafe.user.username,
                access_token: data.access_token,
                init_data: initData
            };

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(user_data)
            };

            fetch("/auth", options)
                .then(response => {
                    if (!response.ok) {
                        window.location.replace(`/finish_authorization?status=400`);
                        return;
                    }
                    const status = response.status;
                    window.location.replace(`/finish_authorization?status=${status}`);
                })
                .catch(error => {
                    alert(`Ошибка при отправке данных: ${error.message}`);
                });
        }

        function vkidOnError(error) {
            console.error("Ошибка входа:", error);
        }
    } else {
        console.error("VKID SDK не загружен.");
    }
</script>
{% endblock %}